<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Unicorn Ranch (React)</title>
    <meta name="description" content="Raise a baby unicorn – feed, drink, play, and nap!" />
    <style>
      :root{
        --bg:#cfe8ff; --grass:#b8e986; --water:#9fd3ff; --barn:#d26; --dirt:#e2c39a; --ui:#ffffff; --ui2:#222;
      }
      html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:linear-gradient(#9fd3ff,#cfe8ff 30%,#b8e986 30%);}
      #app{height:100%;}
      .world{position:relative; max-width:1024px; height:640px; margin:0 auto; border-radius:24px; box-shadow:0 10px 40px rgba(0,0,0,.15); overflow:hidden; background:linear-gradient(#9fd3ff,var(--bg) 35%, var(--grass) 35%);}
      .zone{position:absolute; border-radius:20px; outline:4px solid rgba(255,255,255,.6);}
      .lake{left:20px; top:260px; width:260px; height:200px; background:radial-gradient(circle at 40% 30%, #e7f6ff, var(--water));}
      .field{left:300px; top:380px; width:380px; height:160px; background:repeating-linear-gradient( 45deg, rgba(255,255,255,.3), rgba(255,255,255,.3) 10px, transparent 10px, transparent 20px);}
      .play{right:20px; top:280px; width:260px; height:180px; background:linear-gradient(135deg, #fef3bd, #ffd6a5);}
      .barn{left:680px; top:120px; width:300px; height:200px; background:linear-gradient(#f77,#d26);}
      .barn:after{content:""; position:absolute; left:40px; bottom:-40px; width:220px; height:40px; background:var(--dirt); border-radius:20px;}
      .barn-door{position:absolute; left:110px; bottom:0; width:80px; height:120px; background:#5a1; border:6px solid #421; border-bottom:none; border-radius:10px 10px 0 0;}
      .label{position:absolute; top:-28px; left:12px; padding:4px 10px; background:rgba(255,255,255,.9); border-radius:12px; font-weight:700; font-size:14px;}
      .ui{position:absolute; left:12px; top:12px; right:12px; display:flex; gap:10px;}
      .card{background:rgba(255,255,255,.9); padding:8px 12px; border-radius:14px; box-shadow:0 2px 8px rgba(0,0,0,.1);}
      .meters{display:flex; gap:8px; align-items:center;}
      .meter{width:120px; height:10px; background:#eee; border-radius:20px; overflow:hidden;}
      .fill{height:100%; background:linear-gradient(90deg,#7dd,#5d9);}
      .pill{display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border-radius:999px; background:#fff;}
      .btn{cursor:pointer; padding:6px 12px; border-radius:10px; border:none; font-weight:700;}
      .btn:hover{filter:brightness(0.95);}
      .unicorn{position:absolute; left:120px; top:120px; width:120px; height:120px; user-select:none; touch-action:none;}
      .u-emoji{font-size:64px; position:absolute; left:28px; top:24px;}
      .speech{position:absolute; top:-40px; left:0; transform:translateX(-20%); background:#fff; padding:6px 10px; border-radius:12px; box-shadow:0 2px 6px rgba(0,0,0,.2); font-weight:700;}
      .night{filter:brightness(.8) saturate(.9);}
      .stars{position:absolute; inset:0; pointer-events:none;}
      .star{position:absolute; width:4px; height:4px; background:#fff; border-radius:50%; opacity:.9;}
      .modal{position:absolute; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,.5);}
      .panel{background:#fff; padding:18px; border-radius:16px; width:min(92%,520px);}
      .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap;}
    </style>
  </head>
  <body>
    <div id="app"></div>

    <!-- React 18 UMD + JSX runtime via Babel for single-file simplicity -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="text/babel">
      const {useState,useRef,useEffect,useMemo} = React;

      const clamp=(v,min,max)=>Math.max(min,Math.min(max,v));
      const rnd=(a,b)=>Math.random()*(b-a)+a;

      const STORAGE_KEY='unicorn_ranch_react_v1';

      function useLocalStorageState(key, initial){
        const [state,setState]=useState(()=>{
          try{ const raw=localStorage.getItem(key); return raw? JSON.parse(raw): initial;}catch{ return initial; }
        });
        useEffect(()=>{ try{ localStorage.setItem(key, JSON.stringify(state)); }catch{} },[state]);
        return [state,setState];
      }

      function App(){
        const initial = { x: 150, y: 180, needs:{hunger:80, thirst:80, energy:80, fun:70}, age:0, stage:'Baby', day:0, wins:{fed:0, drank:0, napped:0, played:0}, calm:false };
        const [s, setS] = useLocalStorageState(STORAGE_KEY, initial);
        const [drag, setDrag] = useState(null);
        const [now, setNow] = useState(Date.now());
        const [msg, setMsg] = useState('');
        const [showPause, setShowPause]=useState(false);
        const worldRef=useRef(null);

        // zones
        const zones = useMemo(()=>({
          lake:{x:20,y:260,w:260,h:200,label:'Lake 💧', need:'thirst'},
          field:{x:300,y:380,w:380,h:160,label:'Field 🍎', need:'hunger'},
          play:{x:744,y:280,w:260,h:180,label:'Play 🎈', need:'fun'},
          barn:{x:680,y:120,w:300,h:200,label:'Barn 💤', need:'energy'},
        }),[]);

        // day-night cycle (6 minutes per loop)
        const dayMs = 6*60*1000;
        const phase = ((now % dayMs)/dayMs); // 0..1
        const isNight = phase>0.7 || phase<0.2;

        // tick
        useEffect(()=>{
          const id=setInterval(()=>setNow(Date.now()), 1000); // 1s
          return ()=>clearInterval(id);
        },[]);

        useEffect(()=>{
          if(s.calm) return; // paused
          // decay
          setS(prev=>{
            const dec = isNight? {hunger:0.7, thirst:0.7, energy:-0.5, fun:0.4}: {hunger:1, thirst:1, energy:0.6, fun:1};
            const needs = {...prev.needs};
            needs.hunger = clamp(needs.hunger - dec.hunger, 0, 100);
            needs.thirst = clamp(needs.thirst - dec.thirst, 0, 100);
            needs.energy = clamp(needs.energy - dec.energy, 0, 100); // energy drains slower
            needs.fun = clamp(needs.fun - dec.fun, 0, 100);
            return {...prev, needs};
          });

          // prompt messages sometimes
          if(Math.random()<0.15){
            const lowEntries = Object.entries(s.needs).filter(([,v])=>v<55);
            if(lowEntries.length){
              const pick = lowEntries[Math.floor(Math.random()*lowEntries.length)][0];
              const text = pick==='hunger'?"Hungry!": pick==='thirst'?"Thirsty!": pick==='energy'?"Sleepy…":"Play time!";
              setMsg(text);
              setTimeout(()=>setMsg(''), 2200);
            }
          }
          // age up if cared well
          const avg = (s.needs.hunger+s.needs.thirst+s.needs.energy+s.needs.fun)/4;
          if(avg>70){
            setS(prev=>({ ...prev, age: prev.age+1 }));
          }
          // stage calc
          setS(prev=>{
            let stage='Baby';
            if(prev.age>90) stage='Adult'; else if(prev.age>60) stage='Teen'; else if(prev.age>30) stage='Kid';
            return prev.stage===stage? prev: {...prev, stage};
          });
        },[now]);

        function moveUnicorn(e){
          const rect = worldRef.current.getBoundingClientRect();
          const px = clamp((e.clientX||e.touches?.[0]?.clientX)-rect.left, 0, rect.width);
          const py = clamp((e.clientY||e.touches?.[0]?.clientY)-rect.top, 0, rect.height);
          setS(prev=>({...prev, x:px, y:py }));
        }

        function onStart(e){ setDrag(true); moveUnicorn(e); }
        function onMove(e){ if(drag) moveUnicorn(e); }
        function onEnd(){ setDrag(false); checkZone(); }

        function checkZone(){
          const {x,y}=s;
          for(const [key,z] of Object.entries(zones)){
            if(x>z.x && x<z.x+z.w && y>z.y && y<z.y+z.h){
              applyZone(key);
              break;
            }
          }
        }

        function bumpNeed(name, amount){
          setS(prev=>{
            const needs={...prev.needs};
            needs[name]=clamp(needs[name]+amount,0,100);
            const wins={...prev.wins};
            if(name==='hunger') wins.fed++;
            if(name==='thirst') wins.drank++;
            if(name==='energy') wins.napped++;
            if(name==='fun') wins.played++;
            return {...prev, needs, wins};
          });
        }

        function applyZone(key){
          if(key==='lake'){ bumpNeed('thirst', 22); setMsg('Glug glug!'); }
          if(key==='field'){ bumpNeed('hunger', 22); setMsg('Munch munch!'); }
          if(key==='barn'){ bumpNeed('energy', 24); setMsg('Zzz…'); }
          if(key==='play'){ openStarDash(); }
          setTimeout(()=>setMsg(''), 1600);
        }

        const [game, setGame]=useState(null); // {stars,timeLeft,active}
        function openStarDash(){ setGame({stars:0,timeLeft:30,active:true}); }
        useEffect(()=>{
          if(!game?.active) return;
          const id=setInterval(()=>{ setGame(g=> g && g.active? {...g, timeLeft:g.timeLeft-1}: g ); },1000);
          const id2=setInterval(()=>{ // fun ticks
            bumpNeed('fun', 6);
          },1500);
          return ()=>{ clearInterval(id); clearInterval(id2); };
        },[game?.active]);
        useEffect(()=>{ if(game && game.timeLeft<=0){ setGame({...game, active:false}); setMsg('Play was fun!'); } },[game?.timeLeft]);

        function clickStar(e){ if(!game?.active) return; setGame(g=> ({...g, stars:g.stars+1})); }

        const starField = useMemo(()=>{
          const arr=[]; for(let i=0;i<40;i++){ arr.push({left: rnd(0,100), top:rnd(0,100)}); } return arr;
        },[game?.active]);

        function resetSave(){ localStorage.removeItem(STORAGE_KEY); window.location.reload(); }

        return (
          <div className={"world"+(isNight?" night":"")} ref={worldRef}
               onMouseMove={onMove} onMouseUp={onEnd}
               onTouchMove={onMove} onTouchEnd={onEnd}
               >
            {/* UI */}
            <div className="ui">
              <div className="card">
                <div className="row" style={{gap:12}}>
                  <strong>Unicorn Ranch</strong>
                  <span className="pill">Stage: {s.stage}</span>
                  <span className="pill">Day: {Math.floor((now % dayMs)/ (dayMs/24))}</span>
                  <button className="btn" onClick={()=>setShowPause(true)}>Pause ▶︎▮</button>
                  <label className="pill">
                    <input type="checkbox" checked={s.calm} onChange={e=>setS({...s, calm:e.target.checked})} /> Calm Mode
                  </label>
                </div>
                <div className="meters" style={{marginTop:8}}>
                  {Object.entries({hunger:'🍎', thirst:'💧', energy:'🛌', fun:'🎈'}).map(([k,em])=>{
                    const v=s.needs[k];
                    const c=v>65?'#5bd65b': v>35?'#ffd166':'#ef476f';
                    return (
                      <div key={k} className="pill" title={k}>
                        <span style={{fontSize:18}}>{em}</span>
                        <div className="meter"><div className="fill" style={{width:`${v}%`, background:c}}></div></div>
                      </div>
                    );
                  })}
                </div>
              </div>
            </div>

            {/* Zones */}
            <div className="zone lake"><span className="label">Lake 💧</span></div>
            <div className="zone field"><span className="label">Field 🍎</span></div>
            <div className="zone play"><span className="label">Play 🎈</span></div>
            <div className="zone barn">
              <div className="label">Barn 💤</div>
              <div className="barn-door"></div>
            </div>

            {/* Stars overlay at night */}
            {isNight && (
              <div className="stars">
                {Array.from({length:60}).map((_,i)=> (
                  <div key={i} className="star" style={{left:`${Math.random()*100}%`, top:`${Math.random()*100}%`, opacity:rnd(.4,1)}}></div>
                ))}
              </div>
            )}

            {/* Unicorn */}
            <div className="unicorn" style={{left:s.x-60, top:s.y-60}}
                 onMouseDown={onStart}
                 onTouchStart={onStart}
            >
              <div className="u-emoji">🦄</div>
              {msg && <div className="speech">{msg}</div>}
            </div>

            {/* Mini-game modal: Star Dash */}
            {game && (
              <div className="modal" onClick={clickStar}>
                <div className="panel">
                  {game.active? (
                    <>
                      <h2>Star Dash ✨</h2>
                      <p>Tap to collect stars! Time left: <strong>{game.timeLeft}s</strong></p>
                      <div style={{position:'relative', height:220, background:'#222', borderRadius:12, overflow:'hidden'}} onClick={clickStar}>
                        {starField.map((s,i)=> (
                          <div key={i} style={{position:'absolute', left:s.left+'%', top:s.top+'%', width:10, height:10, background:'#fff', borderRadius:'50%'}}></div>
                        ))}
                      </div>
                      <p style={{marginTop:10}}>Stars: <strong>{game.stars}</strong></p>
                      <div className="row">
                        <button className="btn" onClick={()=>setGame(null)}>Close</button>
                      </div>
                    </>
                  ): (
                    <>
                      <h2>Great play! 🎉</h2>
                      <p>You collected <strong>{game.stars}</strong> stars. Fun went up!</p>
                      <div className="row">
                        <button className="btn" onClick={()=>setGame(null)}>OK</button>
                      </div>
                    </>
                  )}
                </div>
              </div>
            )}

            {/* Pause / Wins */}
            {showPause && (
              <div className="modal">
                <div className="panel">
                  <h2>Paused ⏸️</h2>
                  <p>Today’s Wins: 🍎 {s.wins.fed} • 💧 {s.wins.drank} • 💤 {s.wins.napped} • 🎈 {s.wins.played}</p>
                  <div className="row">
                    <button className="btn" onClick={()=>setShowPause(false)}>Resume</button>
                    <button className="btn" onClick={resetSave}>Reset Game</button>
                  </div>
                </div>
              </div>
            )}
          </div>
        );
      }

      ReactDOM.createRoot(document.getElementById('app')).render(<App/>);
    </script>
  </body>
</html>